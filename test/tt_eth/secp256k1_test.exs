defmodule TTEth.Secp256k1Test do
  use TTEth.Case
  alias TTEth.Secp256k1

  describe "ecdsa_sign_compact/2" do
    test "signs correctly" do
      hash =
        <<122, 218, 84, 177, 195, 163, 51, 8, 145, 16, 210, 71, 30, 183, 239, 127, 143, 8, 195,
          253, 4, 51, 95, 26, 146, 82, 20, 19, 29, 88, 224, 232>>

      private_key =
        <<65, 20, 46, 36, 27, 144, 22, 222, 241, 51, 92, 133, 241, 195, 200, 154, 247, 164, 218,
          217, 56, 249, 199, 93, 141, 172, 232, 206, 57, 23, 150, 106>>

      hash
      |> Secp256k1.ecdsa_sign_compact(private_key)
      |> assert_match(
        {:ok,
         {<<66, 208, 156, 224, 128, 204, 129, 24, 195, 244, 115, 153, 215, 19, 38, 120, 165, 166,
            236, 25, 113, 90, 225, 85, 149, 230, 184, 170, 168, 53, 193, 134, 81, 135, 66, 106,
            24, 64, 137, 194, 87, 254, 45, 167, 240, 41, 163, 17, 206, 80, 5, 245, 152, 82, 189,
            35, 156, 41, 13, 26, 82, 44, 27, 93>>, 1}}
      )
    end
  end

  describe "ecdsa_recover_compact/3" do
    test "recovers..." do
      hash =
        <<122, 218, 84, 177, 195, 163, 51, 8, 145, 16, 210, 71, 30, 183, 239, 127, 143, 8, 195,
          253, 4, 51, 95, 26, 146, 82, 20, 19, 29, 88, 224, 232>>

      sig =
        <<234, 129, 52, 173, 66, 205, 116, 241, 195, 246, 194, 21, 8, 89, 243, 52, 176, 247, 6,
          89, 8, 155, 3, 154, 195, 144, 119, 35, 82, 73, 200, 111, 67, 55, 1, 16, 52, 202, 210,
          123, 86, 85, 36, 67, 129, 86, 171, 68, 74, 249, 190, 206, 56, 250, 190, 52, 156, 42, 35,
          224, 79, 209, 35, 63>>

      hash
      |> Secp256k1.ecdsa_recover_compact(sig, _v = 1)
      |> assert_match(
        {:ok,
         <<4, 96, 54, 106, 191, 177, 70, 92, 188, 206, 38, 212, 23, 241, 59, 159, 22, 81, 138, 66,
           183, 162, 242, 58, 242, 128, 163, 151, 181, 36, 97, 49, 11, 182, 67, 165, 63, 240, 228,
           184, 8, 64, 143, 228, 170, 154, 235, 43, 129, 168, 90, 214, 56, 1, 158, 217, 229, 177,
           201, 200, 156, 18, 168, 19, 194>>}
      )
    end
  end

  describe "ec_pubkey_create/1" do
    test "creates a public key from a passed private key" do
      priv =
        <<238, 255, 56, 30, 67, 190, 98, 120, 142, 198, 48, 28, 202, 138, 22, 181, 45, 24, 71,
          105, 156, 241, 102, 167, 211, 182, 175, 204, 235, 23, 163, 84>>

      priv
      |> Secp256k1.ec_pubkey_create()
      |> assert_match(
        {:ok,
         <<4, 152, 50, 78, 223, 162, 101, 130, 69, 69, 56, 143, 176, 124, 78, 47, 137, 162, 245,
           249, 83, 29, 255, 222, 222, 123, 163, 176, 101, 187, 113, 114, 252, 0, 179, 14, 136,
           167, 12, 32, 28, 39, 208, 64, 94, 175, 131, 173, 171, 179, 88, 172, 132, 33, 47, 162,
           26, 26, 243, 8, 46, 77, 144, 0, 64>>}
      )
    end
  end
end
